---
// Fundations
import Button from "@/components/fundations/elements/Button.astro";
import X from "@/components/fundations/icons/X.astro";
// Icons
import Search from "@/components/fundations/icons/Search.astro";
// Content
import { getCollection } from "astro:content";
const posts = await Promise.all(
  (await getCollection("posts")).map(async (post) => ({
    slug: post.slug,

    tags: post.data.tags,
    title: post.data.title,
    pubDate: post.data.pubDate,
    description: post.data.description,
  }))
);
---

<div class="relative">
  <Button
    type="button"
    size="sm"
    variant="default"
    id="searchButton"
    aria-label="Search posts"
    iconOnly
  >
    <Search slot="icon" size="sm" />
  </Button>
  <div
    id="searchModal"
    class="fixed inset-0 hidden overflow-y-auto z-90"
    role="dialog"
    aria-modal="true"
  >
    <div class="min-h-screen px-4 text-center">
      <div
        class="fixed inset-0 bg-white/50 transition-opacity"
        id="modalOverlay"
      >
      </div>
      <div
        class="inline-block relative w-full max-w-2xl p-2 mt-40 text-left align-middle bg-base-900 lg:mt-48 rounded-4xl transition-all transform"
      >
        <div class="hidden">
          <button
            type="button"
            id="closeSearch"
            class="ml-auto cursor-pointer text-base-600 hover:text-base-700"
            aria-label="Close search"
          >
            <X slot="icon" size="sm" />
          </button>
        </div>
        <input
          type="text"
          id="searchInput"
          placeholder="Search posts..."
          class="block w-full h-20 px-4 py-2 font-mono text-3xl text-white border border-transparent appearance-none bg-base-900 rounded-3xl duration-300 placeholder-base-300 focus:bg-transparent focus:outline-none focus:ring-accent-500 focus:ring-offset-2 focus:ring-2 focus:ring-offset-black"
        />

        <div
          id="searchResults"
          class="w-full overflow-y-auto max-h-100 scrollbar-hide"
        >
        </div>
      </div>
    </div>
  </div>
</div>
<script is:inline define:vars={{ posts }}>
  window.addEventListener("load", () => {
    const searchButton = document.getElementById("searchButton");
    const searchModal = document.getElementById("searchModal");
    const modalOverlay = document.getElementById("modalOverlay");
    const searchInput = document.getElementById("searchInput");
    const searchResults = document.getElementById("searchResults");
    const closeSearch = document.getElementById("closeSearch");

    const fuse = new Fuse(posts, {
      keys: ["title", "description", "pubDate", "image", "tags"],
      threshold: 0.3,
      includeMatches: true,
    });

    let currentIndex = -1; // Variable to track the currently highlighted result

    // Function to close the search modal
    function closeSearchModal(e) {
      if (e) {
        e.preventDefault();
        e.stopPropagation();
      }
      searchModal.classList.add("hidden"); // Hide modal
      document.body.style.overflow = ""; // Restore scrolling

      // Clear the input and results
      searchInput.value = ""; // Clear search input field
      searchResults.innerHTML = ""; // Clear search results
      searchResults.classList.add("hidden"); // Ensure results remain hidden
    }

    // Render search results
    function renderResults(results) {
      if (!searchInput.value.trim()) {
        searchResults.innerHTML = "";
        searchResults.classList.add("hidden");
        return;
      }

      if (results.length === 0) {
        searchResults.innerHTML = `
        <div>
          <h3 class="p-8 text-base font-medium text-base-900">
            There's nothing here,...
          </h3>
        </div>
        `;
        searchResults.classList.remove("hidden");
        return;
      }

      searchResults.innerHTML = results
        .map((result, index) => {
          return `
         <div class="mt-4">
           <div  class="relative items-center block p-4 mt-4 duration-300 hover:bg-accent-500 rounded-2xl focus:ring-accent-500 focus:bg-base-5 grid grid-cols-3 gap-4" id="result-${index}">
              <a href="/blog/posts/${result.item.slug}" class="absolute inset-0 z-10"></a>
                <div class="flex flex-col col-span-2">
                  <div class="flex items-center gap-1">
                    <div class="flex items-center gap-1">
                      ${
                        result.item.tags
                          ? result.item.tags
                              .map(
                                (cat) =>
                                  `<span class="text-xs capitalize text-base-200">${cat}</span>`
                              )
                              .join(" , ")
                          : ""
                      }
                    </div>
                    <span>Â·</span>
                    <p class="block text-xs text-base-200">
                      ${new Date(result.item.pubDate).toLocaleDateString(
                        "en-US",
                        {
                          year: "numeric",
                          month: "long",
                          day: "2-digit",
                        }
                      )}
                    </p>
                  </div>
                  <h3 class="block mt-2 font-mono text-sm text-white text-balance pl-8">
                    ${result.item.title}
                  </h3>
                 
                </div>
           </div>
         </div>
        `;
        })
        .join("");

      searchResults.classList.remove("hidden");
      currentIndex = -1; // Reset to no highlighted item after results are rendered
    }

    // Open search modal
    function openSearch(e) {
      e.preventDefault();
      e.stopPropagation();
      searchModal.classList.remove("hidden");
      document.body.style.overflow = "hidden";
      setTimeout(() => searchInput.focus(), 100);
    }

    // Event listeners
    searchButton.addEventListener("click", openSearch);
    closeSearch.addEventListener("click", closeSearchModal);
    modalOverlay.addEventListener("click", closeSearchModal);

    // Perform search when input changes
    searchInput.addEventListener("input", (e) => {
      const value = e.target.value.trim();
      const results = value ? fuse.search(value) : [];
      renderResults(results);
    });

    // Close search on Escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && !searchModal.classList.contains("hidden")) {
        closeSearchModal();
      }
    });

    // Keyboard navigation with arrow keys
    document.addEventListener("keydown", (e) => {
      const resultElements = Array.from(
        searchResults.getElementsByTagName("a")
      );

      if (e.key === "ArrowDown") {
        if (currentIndex < resultElements.length - 1) {
          currentIndex++;
        }
      } else if (e.key === "ArrowUp") {
        if (currentIndex > 0) {
          currentIndex--;
        }
      }

      if (currentIndex >= 0 && currentIndex < resultElements.length) {
        resultElements[currentIndex].focus(); // Focus on the current item
        resultElements[currentIndex].scrollIntoView({
          behavior: "smooth",
          block: "nearest",
        });
      }
    });
  });
</script>
